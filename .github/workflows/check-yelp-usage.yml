name: Check Yelp API Usage

on:
  schedule:
    # Run daily at 9am UTC (adjust to your timezone)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-yelp:
    runs-on: ubuntu-latest
    steps:
      - name: Check Yelp API Status and Quota
        env:
          YELP_API_KEY: ${{ secrets.YELP_API_KEY }}
        run: |
          echo "üîç Checking Yelp Fusion API status and quota..."
          
          # Make a test call and capture headers + body separately
          HEADERS_FILE=$(mktemp)
          RESPONSE=$(curl -s -D "$HEADERS_FILE" -w "\n%{http_code}" \
            -H "Authorization: Bearer $YELP_API_KEY" \
            "https://api.yelp.com/v3/businesses/search?term=coffee&location=Seattle&limit=1")
          
          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Yelp API is working correctly"
            echo ""
            
            # Parse rate limit headers
            DAILY_LIMIT=$(grep -i "ratelimit-dailylimit" "$HEADERS_FILE" | tr -d '\r' | awk '{print $2}')
            REMAINING=$(grep -i "ratelimit-remaining" "$HEADERS_FILE" | tr -d '\r' | awk '{print $2}')
            RESET_TIME=$(grep -i "ratelimit-resettime" "$HEADERS_FILE" | tr -d '\r' | cut -d' ' -f2-)
            
            echo "üìä Rate Limit Status:"
            echo "   Daily Limit: $DAILY_LIMIT"
            echo "   Remaining: $REMAINING"
            echo "   Resets at: $RESET_TIME"
            echo ""
            
            # Calculate usage percentage if headers are present
            if [ -n "$DAILY_LIMIT" ] && [ -n "$REMAINING" ] && [ "$DAILY_LIMIT" -gt 0 ]; then
              USED=$((DAILY_LIMIT - REMAINING))
              USAGE_PERCENT=$((USED * 100 / DAILY_LIMIT))
              
              echo "   Used: $USED / $DAILY_LIMIT ($USAGE_PERCENT%)"
              echo ""
              
              # Alert if usage is at 80% or more
              if [ "$USAGE_PERCENT" -ge 80 ]; then
                echo "üö® ALERT: API usage is at $USAGE_PERCENT% (threshold: 80%)"
                echo "   Only $REMAINING calls remaining today!"
                echo ""
                echo "Check usage: https://www.yelp.com/developers/v3/manage_app"
                rm -f "$HEADERS_FILE"
                exit 1
              elif [ "$USAGE_PERCENT" -ge 60 ]; then
                echo "‚ö†Ô∏è WARNING: API usage is at $USAGE_PERCENT%"
                echo "   Consider monitoring more closely."
              else
                echo "‚úÖ Usage is healthy at $USAGE_PERCENT%"
              fi
            else
              echo "‚ö†Ô∏è Could not parse rate limit headers. Check manually:"
              echo "   https://www.yelp.com/developers/v3/manage_app"
              cat "$HEADERS_FILE"
            fi
            
            rm -f "$HEADERS_FILE"
            
          elif [ "$HTTP_CODE" = "429" ]; then
            echo "üö® ALERT: Rate limit exceeded!"
            echo "You've hit the daily limit of API calls."
            echo ""
            echo "Check usage: https://www.yelp.com/developers/v3/manage_app"
            rm -f "$HEADERS_FILE"
            exit 1
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "üö® ALERT: API key is invalid or expired!"
            echo "Check your YELP_API_KEY secret in GitHub."
            rm -f "$HEADERS_FILE"
            exit 1
          else
            echo "‚ö†Ô∏è Unexpected response: $HTTP_CODE"
            echo "Body: $BODY"
            rm -f "$HEADERS_FILE"
            exit 1
          fi

      - name: Send Slack Alert on Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"üö® Yelp API Alert: Usage at 80%+ or check failed! Review at https://www.yelp.com/developers/v3/manage_app"}' \
              "$SLACK_WEBHOOK"
          else
            echo "No Slack webhook configured. Skipping notification."
          fi
